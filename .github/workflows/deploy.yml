name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USERNAME }}
      run: |
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Copy files to EC2
        scp -i private_key.pem -o StrictHostKeyChecking=no -r ./* ${USER}@${HOST}:/home/ubuntu/flask-cicd-app/
        
        # Connect to EC2 and deploy
        ssh -i private_key.pem -o StrictHostKeyChecking=no ${USER}@${HOST} << 'ENDSSH'
          cd /home/ubuntu/flask-cicd-app
          
          # Stop existing application
          pkill -f gunicorn || true
          
          # Activate virtual environment
          source venv/bin/activate
          
          # Install/update dependencies
          pip install -r requirements.txt
          
          # Make scripts executable
          chmod +x start.sh stop.sh
          
          # Start application
          gunicorn --bind 0.0.0.0:5000 --workers 3 --daemon app:app
          
          echo "Deployment completed successfully!"
        ENDSSH
        
        # Clean up
        rm -f private_key.pem

    - name: Verify Deployment
      env:
        HOST: ${{ secrets.EC2_HOST }}
      run: |
        sleep 10
        curl -f http://${HOST}:5000/health || exit 1
        echo "Application is healthy and running!"
