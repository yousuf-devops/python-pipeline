name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USERNAME }}
      run: |
        echo "$PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Copy files to EC2
        scp -i private_key.pem -o StrictHostKeyChecking=no -r ./* ${USER}@${HOST}:/home/ubuntu/flask-cicd-app/
        
        # Connect to EC2 and deploy
        ssh -i private_key.pem -o StrictHostKeyChecking=no ${USER}@${HOST} << 'ENDSSH'
          cd /home/ubuntu/flask-cicd-app
          
          # Stop existing application
          pkill -f gunicorn || true
          
          # Activate virtual environment
          source venv/bin/activate
          
          # Install/update dependencies
          pip install -r requirements.txt
          
          # Install Nginx if not installed
          sudo apt update
          sudo apt install -y nginx || true
          
          # Configure Nginx
          sudo tee /etc/nginx/sites-available/simplewebsite.site > /dev/null << 'NGINX_CONFIG'
          server {
              listen 80;
              server_name simplewebsite.site www.simplewebsite.site;
              
              location / {
                  proxy_pass http://127.0.0.1:5000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          NGINX_CONFIG
          
          # Enable site if not already enabled
          if [ ! -f /etc/nginx/sites-enabled/simplewebsite.site ]; then
              sudo ln -s /etc/nginx/sites-available/simplewebsite.site /etc/nginx/sites-enabled/
          fi
          
          # Test and restart Nginx
          sudo nginx -t && sudo systemctl restart nginx
          
          # Make scripts executable
          chmod +x start.sh stop.sh
          
          # Start application
          gunicorn --bind 0.0.0.0:5000 --workers 3 --daemon app:app
          
          echo "Deployment completed successfully with domain configuration!"
        ENDSSH
        
        # Clean up
        rm -f private_key.pem

    - name: Verify Deployment via Domain
      env:
        HOST: ${{ secrets.EC2_HOST }}
      run: |
        sleep 15
        # Try both IP and domain health checks
        curl -f http://${HOST}:5000/health || echo "Direct IP check failed, checking via Nginx..."
        curl -f http://${HOST}/health || exit 1
        echo "Application is healthy and running!"
